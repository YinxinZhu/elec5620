{% extends 'base.html' %}
{% block title %}{{ 'All Appointments' if current_user.is_admin else 'Appointments' }}{% endblock %}
{% block content %}
<h1 class="h3 mb-4">{{ 'All Appointments' if current_user.is_admin else 'Appointments' }}</h1>
{% if appointments %}
<div class="table-responsive">
  <table class="table align-middle">
    <thead>
      <tr>
        <th>Date</th>
        <th>Duration</th>
        <th>Location</th>
        <th>Student</th>
        {% if current_user.is_admin %}
        <th>Coach</th>
        {% endif %}
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for appointment in appointments %}
      <tr>
        <td>{{ appointment.slot.start_time.strftime('%d %b %Y %H:%M') }}</td>
        <td>{{ appointment.slot.duration_minutes }} min</td>
        <td>{{ appointment.slot.location_text }}</td>
        <td>{{ appointment.student.name }} ({{ appointment.student.email }})</td>
        {% if current_user.is_admin %}
        <td>
          {% set coach = coach_lookup.get(appointment.slot.coach_id) %}
          {{ coach.name if coach else 'Unknown' }}
        </td>
        {% endif %}
        <td>
          {% set badge_lookup = {
            'booked': 'success',
            'pending_cancel': 'warning',
            'completed': 'secondary',
            'cancelled': 'danger'
          } %}
          <span class="badge bg-{{ badge_lookup.get(appointment.status, 'light') }}">{{ appointment.status.replace('_', ' ')|title }}</span>
        </td>
        <td>
          <form method="post" action="{{ url_for('coach.update_appointment_status', appointment_id=appointment.id) }}" class="d-flex gap-2">
            <select class="form-select form-select-sm" name="status">
              <option value="booked" {% if appointment.status == 'booked' %}selected{% endif %}>Booked</option>
              <option value="pending_cancel" {% if appointment.status == 'pending_cancel' %}selected{% endif %}>Pending cancellation</option>
              <option value="completed" {% if appointment.status == 'completed' %}selected{% endif %}>Completed</option>
              <option value="cancelled" {% if appointment.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" type="submit">Update</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-info">{{ 'No appointments scheduled.' if current_user.is_admin else 'No appointments yet.' }}</div>
{% endif %}
{% endblock %}
